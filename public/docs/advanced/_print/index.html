<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.124.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=canonical type=text/html href=http://localhost:1313/docs/advanced/><link rel=alternate type=application/rss+xml href=http://localhost:1313/docs/advanced/index.xml><link rel="shortcut icon" href="/favicons/favicon.ico?v=1"><link rel=apple-touch-icon href="/favicons/apple-touch-icon-180x180.png?v=1" sizes=180x180><link rel=icon type=image/png href="/favicons/favicon-16x16.png?v=1" sizes=16x16><link rel=icon type=image/png href="/favicons/favicon-32x32.png?v=1" sizes=32x32><link rel=apple-touch-icon href="/favicons/apple-touch-icon-180x180.png?v=1" sizes=180x180><title>Advanced | </title><meta property="og:title" content="Advanced"><meta property="og:description" content="Advanced Guides, Techniques and walk-throughs"><meta property="og:type" content="website"><meta property="og:url" content="http://localhost:1313/docs/advanced/"><meta property="og:site_name" content="Goldydocs"><meta itemprop=name content="Advanced"><meta itemprop=description content="Advanced Guides, Techniques and walk-throughs"><meta name=twitter:card content="summary"><meta name=twitter:title content="Advanced"><meta name=twitter:description content="Advanced Guides, Techniques and walk-throughs"><link rel=stylesheet href=/css/prism.css><link href=/scss/main.css rel=stylesheet><link rel=stylesheet type=text/css href=http://localhost:1313/css/asciinema-player.css><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-light nav-shadow flex-column flex-md-row td-navbar"><a id=agones-top class=navbar-brand href=/><svg viewBox="0 -40 700 300" xmlns="http://www.w3.org/2000/svg"><g fill="#006298" fill-rule="none" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-weight="none" font-size="none" text-anchor="none" style="mix-blend-mode:normal" transform="matrix(1, 0, 0, 1, 4.033676, -59.776756)"><g data-paper-data='{"isGlobalGroup":true,"bounds":{"x":65,"y":134.91096067769388,"width":420,"height":200.17807864461224}}'><g data-paper-data='{"isPrimaryText":true}' fill-rule="nonzero" transform="matrix(1.506311, 0, 0, 1.608315, -96.423798, -293.86853)" style=""><path d="M99.87138 315.5382c-1.20049 6.40261-6.57411 11.03307-12.97673 11.03307-7.14577.0-12.80523-6.00245-12.80523-13.49122.0-7.54594 5.65945-13.60555 12.80523-13.60555 4.4018.0 8.74643 2.22948 11.8334 6.80278l6.91711-4.91629c-3.83013-6.23111-10.86158-10.34708-18.80768-10.34708C74.71825 291.01391 65 300.90366 65 313.08006s9.71825 22.00898 21.89465 22.00898c11.31891.0 20.69416-8.63209 21.95182-19.55084z" data-paper-data='{"glyphName":"C","glyphIndex":0,"firstGlyphOfWord":true,"word":1}'/><path d="M134.79992 335.08904c12.1764.0 22.00898-9.88975 22.00898-22.06615s-9.83258-22.00898-22.06615-22.00898c-12.1764.0-22.00898 9.83258-22.00898 22.00898s9.83258 22.06615 22.06615 22.06615zM134.74275 299.4745c7.20294.0 12.97673 6.05962 12.97673 13.54839.0 7.6031-5.71662 13.54839-12.91956 13.54839-7.31727.0-12.97673-5.94528-12.97673-13.54839.0-7.48877 5.65945-13.54839 12.91956-13.54839z" data-paper-data='{"glyphName":"O","glyphIndex":1,"word":1}'/><path d="M163.15435 291.75707v42.58881h17.32136c12.23356.0 22.23765-9.08942 22.23765-21.32299.0-12.11923-10.00408-21.26582-22.29481-21.26582zm8.86076 34.58554v-26.58228h8.40343c7.4316.0 13.20539 5.54512 13.20539 13.26256.0 7.66027-5.77379 13.31972-13.14822 13.31972z" data-paper-data='{"glyphName":"D","glyphIndex":2,"word":1}'/><path d="M235.46958 334.34588v-8.00327h-17.55002V315.7097h16.00653v-8.00327h-16.00653v-7.9461h13.77705v-8.00327H209.0588v42.58881z" data-paper-data='{"glyphName":"E","glyphIndex":3,"word":1}'/><path d="M256.67824 334.34588c7.83177.0 15.09187-5.03062 15.09187-13.71989.0-4.11597-1.94365-7.7746-5.77379-10.40425 2.05798-1.88648 3.02981-4.2303 3.02981-7.20294.0-7.9461-5.65945-11.26174-13.54839-11.26174h-13.66272v42.58881zM250.67579 326.34261V315.3667h6.28828c3.65864.0 5.71662 2.11515 5.71662 5.54512.0 3.31564-2.05798 5.43079-5.71662 5.43079zm0-18.69334v-7.88893h4.45896c2.45815.0 4.80196.68599 4.80196 3.94447.0 1.77215-.5145 3.94447-4.80196 3.94447z" data-paper-data='{"glyphName":"B","glyphIndex":4,"word":1}'/><path d="M278.11556 291.75707v42.58881h26.01062v-8.00327h-17.14986v-34.58555z" data-paper-data='{"glyphName":"L","glyphIndex":5,"word":1}'/><path d="M317.90323 291.75707h-8.86076v42.58881h8.86076z" data-paper-data='{"glyphName":"I","glyphIndex":6,"word":1}'/><path d="M356.31891 316.3957l-30.29808-25.43895v43.38914h8.86076v-24.46713l30.29808 25.21029v-43.33197h-8.86076z" data-paper-data='{"glyphName":"N","glyphIndex":7,"word":1}'/><path d="M373.29726 291.75707v42.58881h17.32136c12.23356.0 22.23765-9.08942 22.23765-21.32299.0-12.11923-10.00408-21.26582-22.29481-21.26582zM382.15802 326.34261v-26.58228h8.40343c7.4316.0 13.20539 5.54512 13.20539 13.26256.0 7.66027-5.77379 13.31972-13.14822 13.31972z" data-paper-data='{"glyphName":"D","glyphIndex":8,"word":1}'/></g><g data-paper-data='{"fillRule":"evenodd","fillRuleOriginal":"evenodd","isIcon":true,"iconStyle":"standalone","selectedEffects":{"container":"triangle_simple_outline3","transformation":"","pattern":""},"bounds":{"x":200.4253260667158,"y":134.91096067769388,"width":149.1493478665684,"height":129.93559557606665},"widthRatioIconToContainer":0.46864262218011316,"heightRatioIconToContainer":0.5128464428206175,"relativeBoundsIconToContainer":{"top":0.1511909708697078,"left":0.00000405714571068623},"iconType":"icon","rawIconId":"22591","isDetailed":false,"blockLetter":"A","suitableAsStandaloneIcon":true}' fill-rule="evenodd" transform="matrix(0.857575, 0, 0, 0.832887, 371.420288, 37.764965)" style=""><path d="M240.08737 218.30866l-.03565-.03565.03565-.21459c0-3.26912.85904-7.02682 2.57713-11.2738 1.07363-2.36185 2.46949-4.70062 4.18758-7.01493.90657-1.24068 2.39819-2.85113 4.47346-4.83203 2.14726-1.81315 4.21134-3.26842 6.19154-4.36651 1.76562-.97857 3.99676-1.92079 6.69271-2.82736 2.19549-.71575 5.07038-1.21692 8.62538-1.5028l.85904-.03565v.03565l.07199-.03565h2.11161l.25024.03565.03565-.03565.21528.03565c2.95807.0 6.5613.69199 10.80829 2.07597 2.38631.88281 4.74815 2.02843 7.08694 3.43617 1.45527.85904 3.14959 2.11161 5.08226 3.75771 2.33878 2.21925 3.88911 3.93664 4.65239 5.15426 1.79008 2.43314 3.18594 5.04592 4.18758 7.83763 1.14562 3.4837 1.71809 6.52566 1.71809 9.12655l.03495.14259h-.03565l.03565.03565v2.2542l-.03565.03635.03565.03635c0 1.76492-.35788 4.3057-1.07363 7.62305-.66822 2.33808-1.39586 4.34205-2.18291 6.01261-.85904 1.69432-2.02773 3.51935-3.50816 5.47579-.9541 1.16939-2.19549 2.49326-3.72205 3.97299-2.4576 2.07597-4.53287 3.61511-6.22719 4.61675-.73952.38164-1.40774.57247-2.00397.57247-1.59856.0-2.67219-.78775-3.22089-2.36254-.09576-.42917-.14329-.79963-.14329-1.10928.0-1.36021 1.19316-2.66031 3.57947-3.90099.73952-.35788 1.92009-1.26515 3.54242-2.72042 2.07597-2.0522 3.51935-3.75771 4.33086-5.11791.93034-1.43151 1.70551-2.92313 2.3262-4.47346.85904-2.43314 1.28822-4.02051 1.28822-4.76003l.35858-2.29055-.07199-.03565.07199-.21528v-.32223l.03565-.03635-.03565-.03565.03565-.14329.03565-1.61045c0-7.11-2.63584-13.29036-7.90893-18.53898-1.95644-1.74185-3.39983-2.87489-4.33016-3.39983-4.86768-3.03007-10.00935-4.54545-15.42574-4.54545h-1.64609l-.21459.03565v-.03565l-.03565.03565h-.03635c-2.40937.0-5.32062.56058-8.73232 1.68244-1.81385.69199-3.63888 1.59856-5.47579 2.72042-1.16939.69199-2.79172 2.00397-4.86768 3.93664l-1.18127 1.28822c-4.55733 5.08226-6.836 10.90405-6.836 17.46535l.03565.39352h-.03635l.03565.03565v.03565c0 4.67686 1.95644 10.04501 5.86931 16.10584 3.17336 4.72439 5.51214 8.29127 7.01493 10.70135.52493.88351 1.03728 1.86068 1.53845 2.93501h-.03565c-3.19712-1.45527-6.17966-3.16147-8.94761-5.11791-2.09972-1.64609-3.80523-3.30546-5.11791-4.97462-1.5028-2.09972-2.61278-3.88911-3.32853-5.36885-.85904-1.67055-1.65868-3.75771-2.39819-6.26353-.42917-1.57479-.77517-3.2803-1.03798-5.11722l-.17894-1.96832h.03565l-.03565-.03635-.03495-1.82503v-1.00234l.03565-.03565-.03565-.03565v-.03565zm34.03601-22.7622h2.04032l.03565.07199.03635-.07199c1.59856.04753 3.65076.38164 6.15589 1.00234 2.17103.69199 3.97299 1.44339 5.40379 2.2549 1.33645.73952 2.86371 1.86138 4.58179 3.36418 2.14726 2.07597 3.53124 3.63888 4.15123 4.68874 1.16939 1.69432 2.07597 3.49558 2.72042 5.40449.52493 1.31198.89469 3.20901 1.10928 5.69038v.03565h-.03565l.03565.03565v1.32457c0 6.46554-2.67219 12.24049-8.01727 17.32206-2.4576 2.17103-4.0324 3.29288-4.72439 3.36418-.42917.19082-.89399.28588-1.39586.28588h-.07129c-1.5035.0-2.55336-.7514-3.14959-2.2549l-.17964-1.07363c0-1.57479 1.04986-2.82736 3.14959-3.75771.66822-.33481 1.44339-.93104 2.3262-1.79008 1.40844-1.47973 2.41007-2.83924 3.007-4.08063.5487-.9541 1.07363-2.28985 1.57479-4.00793.28588-1.40774.42917-2.42195.42917-3.04195h.03565l-.03565-.0727.03565-.17894v-1.93267l-.03565-.17894h.03565l-.03565-.14329c0-1.74185-.60811-3.84158-1.82503-6.29918-.59693-1.0974-1.46785-2.26679-2.61278-3.50747-1.21622-1.24068-2.24232-2.09972-3.0776-2.57713-3.38794-2.17103-6.76401-3.25724-10.12818-3.25724h-.10694l-.03635-.07199-.03565.07199h-.10764l-.03565-.07199-.03565.07199h-.39352l-.03635-.07199-.03565.07199h-.64446l-.21459.03565v-.03565c-1.5028.14329-2.67219.33411-3.50816.57247-4.00793 1.14492-7.13376 3.03007-9.37678 5.65473-1.28891 1.40774-2.29055 2.89866-3.0063 4.47346-.93034 2.17103-1.39586 4.21134-1.39586 6.12025v.7514l-.03565.03565.03565.03565v.07129c0 3.14959 1.19316 6.47812 3.57876 9.98559 6.06083 9.6389 10.72511 17.28641 13.99423 22.94114l-.03565.03565h-.03635c-4.17569-.38164-6.96741-.77517-8.37445-1.18057-5.55897-8.78056-8.67292-13.66012-9.34113-14.63729-2.95877-4.48604-4.79568-7.77892-5.51143-9.87865-.78775-2.36185-1.18127-4.80827-1.18127-7.33716.0-5.48767 1.80126-10.52241 5.40449-15.10351.5487-.71575 1.68174-1.8495 3.39983-3.39983 3.24536-2.57713 6.78777-4.28264 10.62935-5.11791 1.38467-.30685 3.0063-.52213 4.86768-.64096v.07199zM274.69654 205.06653h1.10998l.07199.07199.03565-.07199h.03565l.03635.07199.03565-.07199c1.04986.0 2.46949.25024 4.25957.7514 3.6263 1.28822 6.38236 3.67453 8.26751 7.15823 1.04986 2.17103 1.57479 4.29522 1.57479 6.37048v.21459c0 3.96111-1.7062 7.55175-5.11791 10.77264-1.43151 1.14562-2.7323 1.71809-3.90099 1.71809-1.45597.0-2.54148-.77517-3.25724-2.3262-.11883-.33411-.19012-.68011-.21459-1.03798.0-1.19246.88281-2.39749 2.64842-3.61441 1.26445-.85904 2.07597-1.8495 2.43314-2.97065.28658-.81151.42917-1.61045.42917-2.39819v-.14329c0-2.38631-1.04986-4.49792-3.14959-6.33484-1.38328-1.0261-3.10206-1.53915-5.15356-1.53915l-.28588.03565v-.03565l-.03635.03565h-.07199c-1.88444.0-3.69829.81081-5.43944 2.43314-1.40844 1.62233-2.11161 3.4837-2.11161 5.58343.0 1.78938 1.2288 4.42593 3.68641 7.90963 6.34672 9.99747 11.22628 17.88264 14.63729 23.65759-3.05383.81081-5.40379 1.21622-7.05059 1.21622-3.14959-4.5811-6.84788-10.4623-11.09487-17.64359-1.45527-2.43384-3.0776-4.95156-4.86698-7.55245-1.59856-2.48137-2.39889-5.07038-2.39889-7.76634.0-3.74582 1.37209-7.06247 4.11628-9.94925 1.47904-1.36021 2.82736-2.32689 4.04428-2.89866 2.17103-.90657 3.61511-1.36021 4.33016-1.36021.4061-.09506 1.19316-.19082 2.36254-.28588v.07199zm74.56087 55.60127c.0215.04174.0421.08398.06181.1267.01926.04277.0374.08599.05442.12966.01747.04366.03381.08771.04904.13215.01478.04448.02867.08926.04165.13436.01299.04515.02486.09058.0356.13631.0103.04573.0197.09168.02822.13785.00851.04618.0159.09253.02217.13907.00582.04653.01075.0932.01478.14001.00358.04676.00627.09361.00806.14054.00134.04694.00179.09385.00134.14074-89e-5.04694-.00291.09383-.00605.14068-.00313.04685-.00739.09358-.01277.14021-.00538.04667-.01186.09316-.01948.13947-.00761.04631-.01635.0924-.0262.13825-.00985.04591-.02083.09153-.03292.13684-.0121.04537-.0253.09038-.03964.13503-.01478.0447-.03023.08901-.04636.13295-.01657.04394-.03426.08745-.05307.13053-.01881.04304-.03852.08561-.05912.12771s-.04232.08369-.06516.12476c-.02284.04102-.0468.08147-.07188.12133-.02463.03986-.05038.07909-.07726.1177-.02642.03856-.05397.07648-.08263.11373-.02867.03722-.05822.07374-.08868.10957-.03046.03579-.06158.07081-.09338.10507-.03225.03426-.06516.06772-.09875.10037s-.06808.06445-.10346.0954c-.03538.03095-.07144.061-.10816.09015-.03673.0292-.07412.05746-.11219.08478-.03852.02736-.07748.05377-.1169.07921-.03941.02544-.0795.04989-.12025.07336-.21766.12585-.44809.22136-.69128.28652-.2432.06516-.49064.09775-.74234.09775H203.29356c-.04694.0-.09385-.00116-.14074-.00349-.04689-.00228-.0937-.00573-.14041-.01034-.04671-.00457-.09327-.0103-.13967-.0172-.04645-.0069-.09269-.01494-.13872-.02412-.04604-.00914-.09184-.01941-.13738-.03084-.04551-.01137-.09071-.02389-.13564-.03756-.04492-.01362-.08948-.02833-.13369-.04414-.04421-.01581-.08798-.03269-.13134-.05065-.0434-.01796-.08631-.03697-.12872-.05703-.04246-.02007-.08438-.04116-.12576-.06328-.04138-.02217-.0822-.0453-.12247-.0694-.04026-.02414-.07992-.04926-.11898-.07537-.03901-.02606-.07737-.05307-.11508-.08102-.03771-.028-.0747-.05686-.11098-.0866-.03628-.02979-.07182-.06044-.10661-.09197-.0348-.03153-.0688-.06389-.10198-.09707-.03319-.03319-.06554-.06718-.09707-.10198-.03153-.03475-.06217-.07029-.09191-.10661-.02979-.03628-.05867-.07327-.08666-.11098-.02795-.03771-.05495-.07607-.08102-.11508-.02611-.03905-.05121-.07871-.07531-.11898-.02414-.04022-.04727-.08104-.0694-.12247-.02213-.04138-.04324-.0833-.06335-.12576-.02007-.04241-.03908-.0853-.05703-.12865-.01796-.0434-.03484-.0872-.05065-.13141-.01581-.04416-.03052-.0887-.04414-.13362-.01366-.04492-.02618-.09015-.03756-.1357-.01142-.04555-.0217-.09134-.03084-.13738-.00918-.04604-.01722-.09226-.02412-.13866-.00685-.04645-.01259-.09302-.0172-.13974-.00462-.04671-.00806-.09352-.01034-.14041-.00233-.04689-.00349-.09381-.00349-.14074.0-.25175.03258-.4992.09775-.74234.06516-.2432.16067-.47378.28652-.69175l71.7064-124.19911c.02347-.04067.04792-.08073.07336-.12018.02544-.03946.05184-.07827.07921-.11643.02732-.03816.05558-.07563.08478-.11239.02916-.03677.0592-.0728.09015-.1081.03095-.03529.06275-.0698.0954-.10352.03265-.03372.0661-.06662.10037-.09868.03426-.03211.06929-.06335.10507-.09372.03579-.03037.07231-.05984.10957-.08841.03722-.02858.07513-.05623.11373-.08296.03861-.02669.07784-.05245.1177-.07726.03986-.02477.0803-.04855.12133-.07135.04102-.0228.08261-.04459.12476-.06536.0421-.02074.08467-.04044.12771-.05912.04308-.01867.0866-.03628.13053-.05281.04394-.01657.08823-.03202.13288-.04636.0447-.01438.08973-.02763.1351-.03977.04533-.01214.09094-.02318.13684-.03312.04586-.0099.09195-.01867.13825-.02633.04631-.00761.09278-.01411.1394-.01948.04667-.00538.09343-.00958.14027-.01263.0468-.00309.09367-.00502.14061-.00578.04694-76e-5.09387-38e-5.14081.00114.04689.00152.09374.00421.14054.00806.0468.00385.09347.00882.14001.01491.04653.00614.09289.01342.13907.02184.04618.00837.09213.01789.13785.02855.04573.01066.09116.02244.13631.03533.0451.0129.08988.02689.13436.04199.04443.01509.08848.03126.13215.0485.04366.01724.08686.03556.12959.05495.04277.01934.08503.03975.12677.0612.04178.02146.08299.04392.12361.06738.21802.1259.41604.27784.59408.45582.17798.17802.32993.37605.45582.59408l71.70627 124.19911c.02374.04062.04613.08182.06718.12361zM274.99998 143.5157l-66.73842 115.59433H341.7386z" data-paper-data='{"isPathIcon":true}'/></g></g></g></svg> <span class="text-uppercase fw-bold"></span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/josephbarnett/codeblind.ai>GitHub</a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://app.codeblind.ai>Login</a></li></ul></div><div class="navbar-nav mx-lg-2 d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/advanced/>Return to the regular view of this page</a>.</p></div><h1 class=title>Advanced</h1><div class=lead>Advanced Guides, Techniques and walk-throughs</div><ul><li>1: <a href=#pg-15980123edc419424a9f2df1a62f3135>Scheduling and Autoscaling</a></li><li>2: <a href=#pg-01cd69ca33036b349a8d47b3ee3df55d>High Availability Code Blind</a></li><li>3: <a href=#pg-6689fca1455445a3c7759b93ee6d69e2>Controlling Disruption</a></li><li>4: <a href=#pg-95571351289b80d85a0bde5b4c1a0b22>Limiting CPU & Memory</a></li><li>5: <a href=#pg-9265a75f393211dcf8575bc3474c7ef6>Out of Cluster Dev Server</a></li><li>6: <a href=#pg-a147578c54e3cfc51d8c84b30bc32cc9>Allocator Service</a></li><li>7: <a href=#pg-522dc6497d01e5cbc17d1c3587704eec>Multi-cluster Allocation</a></li><li>8: <a href=#pg-cd42a2864dd477303091c6e62aeb3c51>GameServer Pod Service Accounts</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-15980123edc419424a9f2df1a62f3135>1 - Scheduling and Autoscaling</h1><div class=lead>Scheduling and autoscaling go hand in hand, as where in the cluster <code>GameServers</code> are provisioned impacts how to autoscale fleets up and down (or if you would even want to)</div><h2 id=cluster-autoscaler>Cluster Autoscaler</h2><p>Kubernetes has a <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>cluster node autoscaler that works with a wide variety of cloud providers</a>.</p><p>The default scheduling strategy (<code>Packed</code>) is designed to work with the Kubernetes autoscaler out of the box.</p><p>The autoscaler will automatically add Nodes to the cluster when <code>GameServers</code> don&rsquo;t have room to be scheduled on the
clusters, and then scale down when there are empty Nodes with no <code>GameServers</code> running on them.</p><p>This means that scaling <code>Fleets</code> up and down can be used to control the size of the cluster, as the cluster autoscaler
will adjust the size of the cluster to match the resource needs of one or more <code>Fleets</code> running on it.</p><p>To enable and configure autoscaling on your cloud provider, check their <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler/cloudprovider>connector implementation</a>,
or their cloud specific documentation.</p><h3 id=google-kubernetes-engine>Google Kubernetes Engine</h3><ul><li><a href=https://cloud.google.com/kubernetes-engine/docs/how-to/cluster-autoscaler>Administering Clusters: Autoscaling a Cluster</a></li><li><a href=https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler>Cluster Autoscaler</a></li></ul><h3 id=amazon-elastic-kubernetes-service>Amazon Elastic Kubernetes Service</h3><ul><li><a href=https://docs.aws.amazon.com/eks/latest/userguide/cluster-autoscaler.html>Cluster Autoscaler for EKS</a></li></ul><h3 id=azure-kubernetes-service>Azure Kubernetes Service</h3><ul><li><a href=https://docs.microsoft.com/en-us/azure/aks/autoscaler>Cluster Autoscaler on Azure Kubernetes Service (AKS) - Preview</a></li></ul><h2 id=fleet-autoscaling>Fleet Autoscaling</h2><p>Fleet autoscaling is the only type of autoscaling that exists in Code Blind. It is currently available as a
buffer autoscaling strategy or as a webhook driven strategy, such that you can provide your own autoscaling logic.</p><p>Have a look at the <a href=/docs/getting-started/create-fleetautoscaler/>Create a Fleet Autoscaler</a> quickstart, the
<a href=/docs/getting-started/create-webhook-fleetautoscaler/>Create a Webhook Fleet Autoscaler</a> quickstart,
and the <a href=/docs/reference/fleetautoscaler/>Fleet Autoscaler Specification</a> for details.</p><h2 id=autoscaling-concepts>Autoscaling Concepts</h2><p>To facilitate autoscaling, we need to combine several concepts and functionality, as described below.</p><h3 id=allocation-scheduling>Allocation Scheduling</h3><p>Allocation scheduling refers to the order in which <code>GameServers</code>, and specifically their backing <code>Pods</code> are chosen
from across the Kubernetes cluster within a given <code>Fleet</code> when <a href=/docs/getting-started/create-fleet/#4-allocate-a-game-server-from-the-fleet>allocation</a> occurs.</p><h3 id=pod-scheduling>Pod Scheduling</h3><p>Each <code>GameServer</code> is backed by a Kubernetes <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod/><code>Pod</code></a>. Pod scheduling
refers to the strategy that is in place that determines which node in the Kubernetes cluster the Pod is assigned to,
when it is created.</p><h3 id=fleet-scale-down-strategy>Fleet Scale Down Strategy</h3><p>Fleet Scale Down strategy refers to the order in which the <code>GameServers</code> that belong to a <code>Fleet</code> are deleted,
when Fleets are shrunk in size.</p><h2 id=fleet-scheduling>Fleet Scheduling</h2><p>There are two scheduling strategies for Fleets - each designed for different types of Kubernetes Environments.</p><h3 id=packed>Packed</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;agones.dev/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Fleet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scheduling</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Packed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7654</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>us-docker.pkg.dev/codeblind/examples/simple-server:0.27</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This is the <em>default</em> Fleet scheduling strategy. It is designed for dynamic Kubernetes environments, wherein you wish
to scale up and down as load increases or decreases, such as in a Cloud environment where you are paying
for the infrastructure you use.</p><p>It attempts to <em>pack</em> as much as possible into the smallest set of nodes, to make
scaling infrastructure down as easy as possible.</p><p>This affects the Cluster autoscaler, Allocation Scheduling, Pod Scheduling and Fleet Scale Down Scheduling.</p><h4 id=cluster-autoscaler-1>Cluster Autoscaler</h4><p>When using the &ldquo;Packed&rdquo; strategy, Code Blind will ensure that the Cluster Autoscaler doesn&rsquo;t attempt to evict and move <code>GameServer</code> <code>Pods</code> onto new Nodes during
gameplay.</p><p>If a gameserver can tolerate <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/api-eviction/#how-api-initiated-eviction-works>being evicted</a>
(generally in combination with setting an appropriate graceful termination period on the gameserver pod) and you
want the Cluster Autoscaler to compact your cluster by evicting game servers when it would allow the Cluster
Autoscaler to reduce the number of nodes in the cluster, <a href=/docs/advanced/controlling-disruption/>Controlling Disruption</a> describes
how to choose the <code>.eviction</code> setting appropriate for your <code>GameServer</code> or <code>Fleet</code>.</p><h4 id=allocation-scheduling-strategy>Allocation Scheduling Strategy</h4><p>Under the &ldquo;Packed&rdquo; strategy, allocation will prioritise allocating <code>GameServers</code> to nodes that are running on
Nodes that already have allocated <code>GameServers</code> running on them.</p><h4 id=pod-scheduling-strategy>Pod Scheduling Strategy</h4><p>Under the &ldquo;Packed&rdquo; strategy, Pods will be scheduled using the <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature><code>PodAffinity</code></a>
with a <code>preferredDuringSchedulingIgnoredDuringExecution</code> affinity with <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#interlude-built-in-node-labels>hostname</a>
topology. This attempts to group together <code>GameServer</code> Pods within as few nodes in the cluster as it can.</p><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>The default Kubernetes scheduler doesn&rsquo;t do a perfect job of packing, but it&rsquo;s a good enough job for what we need -
at least at this stage.</div><h4 id=fleet-scale-down-strategy-1>Fleet Scale Down Strategy</h4><p>With the &ldquo;Packed&rdquo; strategy, Fleets will remove <code>Ready</code> <code>GameServers</code> from Nodes with the <em>least</em> number of <code>Ready</code> and
<code>Allocated</code> <code>GameServers</code> on them. Attempting to empty Nodes so that they can be safely removed.</p><h3 id=distributed>Distributed</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;agones.dev/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Fleet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>scheduling</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Distributed</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7654</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>us-docker.pkg.dev/codeblind/examples/simple-server:0.27</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This Fleet scheduling strategy is designed for static Kubernetes environments, such as when you are running Kubernetes
on bare metal, and the cluster size rarely changes, if at all.</p><p>This attempts to distribute the load across the entire cluster as much as possible, to take advantage of the static
size of the cluster.</p><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4><p><code>Distributed</code> scheduling does not set
a <a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#inter-pod-affinity-and-anti-affinity-beta-feature><code>PodAffinity</code></a>
on <code>GameServer</code> <code>Pods</code>, and instead assumes that the default scheduler for your cluster will distribute the
<code>GameServer</code> <code>Pods</code> across the cluster by default.</p><p>If your default scheduler does not do this, you may wish to set your own <code>PodAffinity</code> to spread the load across the
cluster, or update the default scheduler to provide this functionality.</p></div><p>This affects Allocation Scheduling, Pod Scheduling and Fleet Scale Down Scheduling.</p><h4 id=cluster-autoscaler-2>Cluster Autoscaler</h4><p>Since this strategy is not aimed at clusters that autoscale, this strategy does nothing for the cluster autoscaler.</p><h4 id=allocation-scheduling-strategy-1>Allocation Scheduling Strategy</h4><p>Under the &ldquo;Distributed&rdquo; strategy, allocation will prioritise allocating <code>GameServers</code> to nodes that have the least
number of allocated <code>GameServers</code> on them.</p><h4 id=pod-scheduling-strategy-1>Pod Scheduling Strategy</h4><p>Under the &ldquo;Distributed&rdquo; strategy, <code>Pod</code> scheduling is provided by the default Kubernetes scheduler, which will attempt
to distribute the <code>GameServer</code> <code>Pods</code> across as many nodes as possible.</p><h4 id=fleet-scale-down-strategy-2>Fleet Scale Down Strategy</h4><p>With the &ldquo;Distributed&rdquo; strategy, Fleets will remove <code>Ready</code> <code>GameServers</code> from Nodes with at random, to ensure
a distributed load is maintained.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-01cd69ca33036b349a8d47b3ee3df55d>2 - High Availability Code Blind</h1><div class=lead>Learn how to configure your Code Blind services for high availability and resiliancy to disruptions.</div><h2 id=high-availability-for-code-blind-controller>High Availability for Code Blind Controller</h2><p>The <code>agones-controller</code> responsibility is split up into <code>agones-controller</code>, which enacts the Code Blind control loop, and <code>agones-extensions</code>, which acts as a service endpoint for webhooks and the allocation extension API. Splitting these responsibilities allows the <code>agones-extensions</code> pod to be <strong>horizontally scaled</strong>, making the Code Blind control plane <strong>highly available</strong> and more <strong>resiliant to disruption</strong>.</p><p>Multiple <code>agones-controller</code> pods enabled, with a primary controller selected via leader election. Having multiple <code>agones-controller</code> minimizes downtime of the service from pod disruptions such as deployment updates, autoscaler evictions, and crashes.</p><h2 id=extension-pod-configrations>Extension Pod Configrations</h2><p>The <code>agones-extensions</code> binary has a similar <code>helm</code> configuration to <code>agones-controller</code>, see <a href=/docs/installation/install-agones/helm/>here</a>. If you previously overrode <code>agones.controller.*</code> settings, you may need to override the same <code>agones.extensions.*</code> setting.</p><p>To change <code>controller.numWorkers</code> to 200 from 100 values and through the use of <code>helm --set</code>, add the follow to the <code>helm</code> command:</p><div class="alert alert-warning" role=alert>Important: This will not have any effect on any <code>extensions</code> values!</div><pre tabindex=0><code> ...
 --set agones.controller.numWorkers=200
 ...
</code></pre><p>An important configuration to note is the PodDisruptionBudget fields, <code>agones.extensions.pdb.minAvailable</code> and <code>agones.extensions.pdb.maxUnavailable</code>. Currently, the <code>agones.extensions.pdb.minAvailable</code> field is set to 1.</p><h2 id=deployment-considerations>Deployment Considerations</h2><p>Leader election will automatically be enabled and <code>agones.controller.replicas</code> is > 1. <a href=/docs/installation/install-agones/helm/#configuration><code>agones.controller.replicas</code></a> defaults to 2.</p><p>The default configuration now deploys 2 <code>agones-controller</code> pods and 2 <code>agones-extensions</code> pods, replacing the previous single <code>agones-controller</code> pod setup. For example:</p><pre tabindex=0><code>NAME                                 READY   STATUS    RESTARTS   AGE
agones-allocator-78c6b8c79-h9nqc     1/1     Running   0          23h
agones-allocator-78c6b8c79-l2bzp     1/1     Running   0          23h
agones-allocator-78c6b8c79-rw75j     1/1     Running   0          23h
agones-controller-fbf944f4-vs9xx     1/1     Running   0          23h
agones-controller-fbf944f4-sjk3t     1/1     Running   0          23h
agones-extensions-5648fc7dcf-hm6lk   1/1     Running   0          23h
agones-extensions-5648fc7dcf-qbc6h   1/1     Running   0          23h
agones-ping-5b9647874-2rrl6          1/1     Running   0          27h
agones-ping-5b9647874-rksgg          1/1     Running   0          27h
</code></pre><p>The number of replicas for <code>agones-extensions</code> can be set using helm variable <a href=/docs/installation/install-agones/helm/#configuration><code>agones.extensions.replicas</code></a>, but the default is <code>2</code>.</p><p>We expect the aggregate memory consumption of the pods will be slightly higher than the previous singleton pod, but as the responsibilities are now split across the pods, the aggregate CPU consumption should also be similar.</p><h2 id=feature-design>Feature Design</h2><p>Please see <a href=https://github.com/googleforgames/agones/issues/2797>HA Code Blind</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6689fca1455445a3c7759b93ee6d69e2>3 - Controlling Disruption</h1><div class=lead>Game servers running on Code Blind may be disrupted by Kubernetes; learn how to control disruption of your game servers.</div><h2 id=disruption-in-kubernetes>Disruption in Kubernetes</h2><p><a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#voluntary-and-involuntary-disruptions>A <code>Pod</code> in Kubernetes may be disrupted</a> for involuntary reasons, e.g. hardware failure, or voluntary reasons, such as when nodes are drained for upgrades.</p><p>By default, Code Blind assumes your game server should never be disrupted voluntarily and configures the <code>Pod</code> appropriately - but this isn&rsquo;t always the ideal setting. Here we discuss how Code Blind allows you to control the two most significant sources of voluntary <code>Pod</code> evictions, node upgrades and Cluster Autoscaler, using the <code>eviction</code> API on the <code>GameServer</code> object.</p><h2 id=benefits-of-allowing-voluntary-disruption>Benefits of Allowing Voluntary Disruption</h2><p>It&rsquo;s not always easy to write your game server in a way that allows for disruption, but it can have major benefits:</p><ul><li>Compaction of your cluster using <a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler>Cluster Autoscaler</a> can lead to considerable cost savings for your infrastructure.</li><li>Allowing automated node upgrades can save you management toil, and lowers the time it takes to patch security vulnerabilites.</li></ul><h2 id=considerations>Considerations</h2><p>When discussing game server pod disruption, it&rsquo;s important to keep two factors in mind:</p><ul><li><strong><code>TERM</code> signal:</strong> Is your game server tolerant of graceful termination? If you wish to support voluntary disruption, your game server must handle the <code>TERM</code> signal (even if it runs to completion after receiving <code>TERM</code>).</li><li><strong>Termination Grace Period:</strong> After receiving <code>TERM</code>, how long does your game server need to run? If you run to completion after receiving <code>TERM</code>, this is equivalent to the session length - if not, you can think of this as the cleanup time. In general, we bucket the grace period into &ldquo;less than 10 minutes&rdquo;, &ldquo;10 minutes to an hour&rdquo;, and &ldquo;greater than an hour&rdquo;. (See <a href=/docs/advanced/controlling-disruption/#whats-special-about-ten-minutes-and-one-hour>below</a> if you are curious about grace period considerations.)</li></ul><h2 id=eviction-api><code>eviction</code> API</h2><p>The <code>eviction</code> API is specified as part of the <code>GameServerSpec</code>, like:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;agones.dev/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GameServer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;simple-game-server&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>eviction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Always</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>...]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>You can set <code>eviction.safe</code> based on your game server&rsquo;s tolerance for disruption and session length, based on the following diagram:</p><p><img alt="Eviction Decision Diagram" src=../../../diagrams/eviction-decision.dot.png></p><p>In words:</p><ul><li>Does the game server support <code>TERM</code> and terminate within ten minutes?<ul><li>Yes to both: Set <code>safe: Always</code>, and set <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-handler-execution>terminationGracePeriodSeconds</a> to the session length or cleanup time.</li><li>No to either: Does the game server support <code>TERM</code> and terminate within an hour?<ul><li>Yes to both: Set <code>safe: OnUpgrade</code>, and configure <a href=https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-handler-execution>terminationGracePeriodSeconds</a> to the session length or cleanup time.</li><li>No to either: Set <code>safe: Never</code>. If your game server does not terminate within an hour, see <a href=/docs/advanced/controlling-disruption/#considerations-for-long-sessions>below</a>.</li></ul></li></ul></li></ul><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>To maintain backward compatibility with Code Blind prior to the introduction of <code>eviction</code> API, if your game server previously configured the <code>cluster-autoscaler.kubernetes.io/safe-to-evict: true</code> annotation, we assume <code>eviction.safe: Always</code> is intended.</div><div class="alert alert-info" role=alert><h4 class=alert-heading>Note</h4>GKE Autopilot supports only <code>Never</code> and <code>Always</code>, not <code>OnUpgrade</code>.</div><h2 id=whats-special-about-ten-minutes-and-one-hour>What&rsquo;s special about ten minutes and one hour?</h2><ul><li><p><strong>Ten minutes:</strong> Cluster Autoscaler respects <a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#does-ca-respect-gracefultermination-in-scale-down>ten minutes of graceful termination</a> on scale-down. On some cloud products, you can configure <code>--max-graceful-termination-sec</code> to change this, but it is not advised: Cluster Autoscaler is currently only capable of scaling down one node at a time, and larger graceful termination windows slow this down farther (see <a href=https://github.com/kubernetes/autoscaler/issues/5079>autoscaler#5079</a>). If the ten minute limit does not apply to you, generally you should choose between <code>safe: Always</code> (for sessions less than an hour), or see <a href=/docs/advanced/controlling-disruption/#considerations-for-long-sessions>below</a>.</p></li><li><p><strong>One hour:</strong> On many cloud products, <code>PodDisruptionBudget</code> can only block node upgrade evictions for a certain period of time - on GKE this is 1h. After that, the PDB is ignored, or the node upgrade fails with an error. Controlling <code>Pod</code> disruption for longer than one hour requires cluster configuration changes outside of Code Blind - see <a href=/docs/advanced/controlling-disruption/#considerations-for-long-sessions>below</a>.</p></li></ul><h2 id=considerations-for-long-sessions>Considerations for long sessions</h2><p>Outside of Cluster Autoscaler, the main source of disruption for long sessions is node upgrade. On some cloud products, such as GKE Standard, node upgrades are entirely within your control. On others, such as GKE Autopilot, node upgrade is automatic. Typical node upgrades use an eviction based, rolling recreate strategy, and may not honor <code>PodDisruptionBudget</code> for longer than an hour. See <a href=/docs/guides/best-practices/>Best Practices</a> for information specific to your cloud product.</p><h2 id=implementation--under-the-hood>Implementation / Under the hood</h2><p>Each option uses a slightly different permutation of:</p><ul><li>the <code>safe-to-evict</code> annotation to block <a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node>Cluster Autoscaler based eviction</a>, and</li><li>the <code>agones.dev/safe-to-evict</code> label selector to select the <code>agones-gameserver-safe-to-evict-false</code> <code>PodDisruptionBudget</code>. This blocks <a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#what-types-of-pods-can-prevent-ca-from-removing-a-node>Cluster Autoscaler</a> and (for a limited time) <a href=https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#pod-disruption-budgets>disruption from node upgrades</a>.<ul><li>Note that PDBs do influence pod preemption as well, but it&rsquo;s not guaranteed.</li></ul></li></ul><p>As a quick reference:</p><table><thead><tr><th>evictions.safe setting</th><th><code>safe-to-evict</code> pod annotation</th><th><code>agones.dev/safe-to-evict</code> label</th></tr></thead><tbody><tr><td><code>Never</code> (default)</td><td><code>false</code></td><td><code>false</code> (matches PDB)</td></tr><tr><td><code>OnUpdate</code></td><td><code>false</code></td><td><code>true</code> (does not match PDB)</td></tr><tr><td><code>Always</code></td><td><code>true</code></td><td><code>true</code> (does not match PDB)</td></tr></tbody></table><h2 id=further-reading>Further Reading</h2><ul><li><a href=https://github.com/googleforgames/agones/issues/2794><code>eviction</code> design</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-95571351289b80d85a0bde5b4c1a0b22>4 - Limiting CPU & Memory</h1><div class=lead>Kubernetes natively has inbuilt capabilities for requesting and limiting both CPU and Memory usage of running containers.</div><p>As a short description:</p><ul><li>CPU <code>Requests</code> are limits that are applied when there is CPU congestion, and as such can burst above their set limits.</li><li>CPU <code>Limits</code> are hard limits on how much CPU time the particular container gets access to.</li></ul><p>This is useful for game servers, not just as a mechanism to distribute compute resources evenly, but also as a way
to advice the Kubernetes scheduler how many game server processes it is able to fit into a given node in the cluster.</p><p>It&rsquo;s worth reading the <a href=https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/>Managing Compute Resources for Containers</a>
Kubernetes documentation for more details on &ldquo;requests&rdquo; and &ldquo;limits&rdquo; to both CPU and Memory, and how to configure them.</p><h2 id=gameservers>GameServers</h2><p>Since the <code>GameServer</code> specification provides a full <a href=https://v1-27.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.27/#podtemplatespec-v1-core><code>PodSpecTemplate</code></a>,
we can take advantage of both resource limits and requests in our <code>GameServer</code> configurations.</p><p>For example, to set a CPU limit on our <code>GameServer</code> configuration of <code>250m/0.25</code> of a CPU,
we could do so as followed:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;agones.dev/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GameServer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;simple-game-server&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7654</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>us-docker.pkg.dev/codeblind/examples/simple-server:0.27</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;250m&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#this is our limit here</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>If you do not set a limit or request, the default is set by Kubernetes at a 100m CPU request.</p><h2 id=sdk-gameserver-sidecar>SDK GameServer sidecar</h2><p>You may also want to tweak the CPU request or limits on the SDK <code>GameServer</code> sidecar process that spins up alongside
each game server container.</p><p>You can do this through the <a href=http://localhost:1313/docs/installation/install-agones/helm/>Helm configuration</a> when installing Code Blind.</p><p>By default, this is set to having a CPU request value of 30m, with no hard CPU limit. This ensures that the sidecar always has enough CPU
to function, but it is configurable in case a lower, or higher value is required on your clusters, or if you desire
hard limit.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9265a75f393211dcf8575bc3474c7ef6>5 - Out of Cluster Dev Server</h1><div class=lead>Running and debugging server binary locally while connected to a full kubernetes stack</div><p>This section builds upon the topics discussed in <a href=http://localhost:1313/docs/guides/client-sdks/local/>local SDK Server</a>, <a href=http://localhost:1313/docs/guides/local-game-server/>Local Game Server</a>, and <code>GameServer</code> allocation (discussed <a href=http://localhost:1313/docs/integration-patterns/allocation-from-fleet/>here</a>, <a href=http://localhost:1313/docs/reference/gameserverallocation/>here</a>, and <a href=http://localhost:1313/docs/advanced/allocator-service/>here</a>).
Having a firm understanding of those concepts will be necessary for running an &ldquo;out of cluster&rdquo; local server.</p><p>Running an &ldquo;out of cluster&rdquo; dev server combines the best parts of local debugging and being a part of a cluster.
A developer will be able to run a custom server binary on their local machine, even within an IDE with breakpoints.
The server would also be allocatable within a cluster, allowing integration with the project&rsquo;s full stack for handling game server lifetime.</p><p>For each run, the only manual steps required by the developer is to manually run the local SDK Server and to run their custom gameplay binary (each can easily be reused/restarted).
All other state progression will be automatically handled by the custom gameplay server (calling the SDK API), the SDK Server (handling the SDK calls), the cluster <code>GameServer</code> Controller (progressing specific <a href=http://localhost:1313/docs/reference/gameserver/#gameserver-state-diagram>states</a>), and the cluster&rsquo;s allocation system (whether be through <code>GameServerAllocation</code> or via the Allocator Service) &ndash; just as it would when running in a pod in a cluster!</p><p>Out of cluster development is a fantastic option during early prototyping, as it can (optionally) all be run on a single machine with tools such as <a href=http://localhost:1313/docs/installation/creating-cluster/minikube/>Minikube</a>.</p><p>The name &ldquo;out of cluster&rdquo; is to contrast <a href=https://pkg.go.dev/k8s.io/client-go/tools/clientcmd#InClusterConfig>InClusterConfig</a> which is used in the internal golang kubeconfig API.</p><h2 id=prerequisite-steps>Prerequisite steps</h2><p>To be able to run an &ldquo;out of cluster&rdquo; local game server, one needs to first complete a few prerequisite steps.</p><h3 id=cluster-created>Cluster created</h3><p>First, a cluster must have been created that the developer has access to through commands like <code>kubectl</code>.
This cluster could be running on a provider or locally (e.g. on Minikube).
See <a href=http://localhost:1313/docs/installation/creating-cluster/>Create Kubernetes Cluster</a> for more details on how to create a cluster, if not already done so.</p><h3 id=code-blind-gameserver-resource-created>Code Blind <code>GameServer</code> resource created</h3><p>Out of cluster dev servers make use of <a href=http://localhost:1313/docs/guides/local-game-server/>local dev servers</a>.
Follow the instructions there to create a <code>GameServer</code> resource for use with a local game server.
Note that the <code>metadata:annotations:agones.dev/dev-address</code> should be updated to point to the local machine, more details <a href=/docs/advanced/out-of-cluster-dev-server/#forwarded-ports>below</a> around port forwarding.</p><h3 id=sdk-server-available>SDK Server available</h3><p>An &ldquo;out of cluster&rdquo; dev server requires the need to also run the SDK Server locally.</p><p>When a <code>GameServer</code> runs normally in a prod-like environment, the Code Blind cluster controller will handle initializing the containers which contain the SDK Server and the game server binary.
The game server binary will be able to connect over gRPC to the SDK Server running in the sidecar container.
When the game server binary makes SDK calls (e.g. <code>SDK.Ready()</code>), those get sent to the SDK Server via gRPC and the SDK Server as able to modify the <code>GameServer</code> resource in the cluster.
When the <code>GameServer</code> resource gets modified (either by the Code Blind cluster controller, by the Code Blind Allocation Service, or by the K8s API), the SDK Server is monitoring and sends update events over gRPC to the SDK API, resulting in a callback in the game server binary logic.</p><p>The goal of an &ldquo;out of cluster&rdquo; dev server is to keep all this prod-like functionality, even in a debuggable context.
To do so, the developer must run the SDK Server locally such that the (also local) game server binary can connect via gRPC.
Instructions for downloading and running the SDK Server can be found <a href=http://localhost:1313/docs/guides/client-sdks/local/>here</a>.
However, instead of using <code>--local</code> or <code>--file</code>, the SDK Server will need to be run in &ldquo;out of cluster&rdquo; mode by providing a kubeconfig file to connect to the cluster. This section is focusing on getting the SDK Server ready to run locally, more detail about running it can be found <a href=/docs/advanced/out-of-cluster-dev-server/#running-sdk-server-locally>below</a>.</p><h3 id=game-server-binary-available>Game server binary available</h3><p>When running Code Blind normally, the game server binary is inside a prebuilt docker image which is loaded into a container in a <code>GameServer</code>&rsquo;s pod.
This can either be a custom, developer-created, docker image and contained binary or a sample image/binary from an external source.
This document will use the sample <code>simple-game-server</code>, which follows suit from various other documentation pages (e.g. <a href=http://localhost:1313/docs/getting-started/create-gameserver/>Quickstart: Create a Game Server</a>).</p><p>The <code>simple-game-server</code> can be run from the docker image <code>us-docker.pkg.dev/codeblind/examples/simple-server:0.27</code>.
The game server binary can either be run within a docker container or run locally, so long as all ports are published/forward &ndash; more on this <a href=/docs/advanced/out-of-cluster-dev-server/#forwarded-ports>below</a>.</p><p>Alternatively, the <code>simple-game-server</code> can also be run from source code; see <code>examples/simple-game-server/main.go</code>. More details about running from source can be found <a href=http://localhost:1313/docs/guides/client-sdks/local/#running-from-source-code-instead-of-prebuilt-binary>here</a>.</p><p><strong>Disclaimer:</strong> Code Blind is run and tested with the version of Go specified by the <code>GO_VERSION</code> variable in the project&rsquo;s <a href=https://github.com/googleforgames/agones/blob/main/build/build-image/Dockerfile>build Dockerfile</a>. Other versions are not supported, but may still work.</p><p>If a developer has their own game server logic, written in the language of their choice, that would be perfectly fine.
A custom game server can be similarly run within a docker container, run directly on commandline, or run via an IDE/debugger.</p><h3 id=forwarded-ports>Forwarded Ports</h3><p>As the game server binary will be run on the developer&rsquo;s machine and a requesting client will attempt to connect to the game server via the <code>GameServer</code>&rsquo;s <code>metadata:annotations:agones.dev/dev-address</code> and <code>spec:ports:hostPort</code> fields, the developer needs to ensure that connection can take place.</p><p>If the game server binary and the arbitrary connecting client logic are both on the same network, then connecting should work without any extra steps.
However, if the developer has a more complicated network configuration or if they are attempting to connect over the public internet, extra steps may be required.</p><p>Obviously, this document does not know what every developer&rsquo;s specific network configuration is, how their custom game client(s) work, their development environment, and/or various other factors.
The developer will need to figure out which steps are necessary for their specific configuration.</p><p>If attempting to connect via the internet, the developer needs to set the <code>GameServer</code>&rsquo;s <code>metadata:annotations:agones.dev/dev-address</code> field to their public IP.
This can be found by going to <a href=https://www.whatsmyip.org/>whatsmyip.org</a> or <a href=https://www.whatismyip.com/>whatismyip.com</a> in a web browser.</p><p>The <code>GameServer</code>&rsquo;s <code>spec:ports:hostPort</code>/<code>spec:ports:containerPort</code> should be set to whichever port the game server binary&rsquo;s logic will bind to &ndash; the port used by <code>simple-game-server</code> is 7654 (by default).
The local network&rsquo;s router must also be configured to forward this port to the desired machine; allowing inbound external requests (from the internet) to be directed to the machine on the network that is running the game server.</p><p>If the SDK Server is run on the same machine as the game server binary, no extra steps are necessary for the two to connect.
By default, the SDK API (in the game server binary) will attempt to gRPC connect to the SDK Server on <code>localhost</code> on the port <code>9357</code>.
If the SDK Server is run on another machine, or if the SDK Server is set to use different ports (e.g. via commandline arguments), the developer will need to also take appropriate steps to ensure that the game server can connect to the SDK Server.
As discussed <a href=/docs/advanced/out-of-cluster-dev-server/#running-sdk-server-locally>further below</a> running the SDK Server with <code>--address 0.0.0.0</code> can be quite helpful with various setups.</p><p>If the developer is running the SDK Server or the game server binary within docker container(s), then publishing ports and/or connecting to a docker network may be necessary.
Again, these configurations can vary quite dramatically and the developer will need to find the necessary steps for their specific setup.</p><h2 id=running-out-of-cluster-local-game-server>Running &ldquo;out of cluster&rdquo; local game server</h2><p>Now that all prerequisite steps have been completed, the developer should have:</p><ul><li>a <a href=/docs/advanced/out-of-cluster-dev-server/#cluster-created>cluster</a> with a configured <a href=/docs/advanced/out-of-cluster-dev-server/#agones-gameserver-resource-created><code>GameServer</code> resource</a>.</li><li>the <a href=/docs/advanced/out-of-cluster-dev-server/#sdk-server-available>SDK Server</a> ready to run.</li><li>a <a href=/docs/advanced/out-of-cluster-dev-server/#game-server-binary-available>game server binary</a> ready to run.</li></ul><h3 id=optional-gameserver-state-monitoring>Optional <code>GameServer</code> state monitoring</h3><p>A helpful (optional) step to see progress when running is to watch the <code>GameServer</code> resource.</p><p>This can be done with the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get --watch -n default gs my-local-server
</span></span></code></pre></div><p>It may be necessary to replace <code>default</code> and <code>my-local-server</code> with whichever namespace/name values are used by the dev <code>GameServer</code> created <a href=/docs/advanced/out-of-cluster-dev-server/#agones-gameserver-resource-created>above</a>).</p><p>With this command running, the terminal will automatically show updates to the <code>GameServer</code>&rsquo;s state &ndash; however, this is not necessary to proceed.</p><h3 id=running-sdk-server-locally>Running SDK Server locally</h3><p>The first step is to run the SDK Server, making it available for the (later run) game server binary to connect.
Here is a sample command to run the SDK Server, with each argument discussed after.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./sdk-server.linux.amd64 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --gameserver-name my-local-server <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --pod-namespace default <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --kubeconfig <span style=color:#4e9a06>&#34;</span><span style=color:#000>$HOME</span><span style=color:#4e9a06>/.kube/config&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --address 0.0.0.0 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --graceful-termination <span style=color:#204a87>false</span>
</span></span></code></pre></div><ul><li><code>--gameserver-name</code> is a necessary arg, passed instead of the <code>GAMESERVER_NAME</code> enviroment variable.<ul><li>It is set to the name of the dev <code>GameServer</code> k8s resource.</li><li>It tells the SDK Sever which resource to read/write to on the k8s cluster.</li><li>This example value of <code>my-local-server</code> matches to the instructions for setting up a <a href=http://localhost:1313/docs/guides/local-game-server/>Local Game Server</a>.</li></ul></li><li><code>--pod-namespace</code> is a necessary arg, passed instead of the <code>POD_NAMESPACE</code> enviroment variable.<ul><li>It is set set to the namespace which the dev <code>GameServer</code> resides in.</li><li>It tells the SDK Sever which namespace to look under for the <code>GameServer</code> to read/write to on the k8s cluster.</li><li>This example value of <code>default</code> is used as most instructions in this documentation assumes <code>GameServers</code> to be created in the <code>default</code> namespace.</li></ul></li><li><code>--kubeconfig</code> tells the SDK Server how to connect to the k8s cluster.<ul><li>This actually does not trigger any special flow (unlike <code>--local</code> or <code>--file</code>).
The SDK Server will run just as it would when created in a sidecar container in a k8s cluster.</li><li>Passing this argument simply provides where to connect along with the credentials to do so.</li><li>This example value of <code>"$HOME/.kube/config"</code> is the default location for k8s authentication information. This requires the developer be logged in via <code>kubectl</code> and have the desired cluster selected via <a href=https://jamesdefabia.github.io/docs/user-guide/kubectl/kubectl_config_use-context/><code>kubectl config use-context</code></a>.</li></ul></li><li><code>--address</code> specifies the binding IP address for the SDK Server&rsquo;s SDK API.<ul><li>By default, the binding address is <code>localhost</code>. This may be difficult for some development setups.</li><li>Overriding this value changes which IP address(es) the server will bind to for receiving gRPC/REST SDK API calls.</li><li>This example value of <code>0.0.0.0</code> sets the SDK Server to receive API calls that are sent to any IP address (that reach the machine).</li></ul></li><li><code>--graceful-termination</code> set to false will disable some smooth state transitions when exiting.<ul><li>By default, the SDK Server will wait until the <code>GameServer</code> has reached the <code>Shutdown</code> state before exiting (&ldquo;graceful termination&rdquo;).</li><li>This will cause the SDK Server to hang (waiting on state update) when attempting to terminate (e.g. with <code>^C</code>).</li><li>When running binaries in a development context, quickly exiting and restarting the SDK Server is handy.</li></ul></li></ul><p>This can easily be terminated with <code>^C</code> and restarted as necessary.
Note that terminating the SDK Server while the game server binary (discussed in the <a href=/docs/advanced/out-of-cluster-dev-server/#running-game-server-binary-locally>next section</a>) is using it may result in failure to update/watch <code>GameServer</code> state and may result in a runtime error in the game server binary.</p><h3 id=running-game-server-binary-locally>Running game server binary locally</h3><p>Now that the SDK Server is running locally with k8s credentials, the game server binary can run in an integrated fashion.
The game server binary&rsquo;s SDK calls will reach the local SDK Server, which will then interact with the <code>GameServer</code> resource on the k8s cluster.</p><p>Again, this document will make use of <code>simple-game-server</code> via its docker image, but running directly or use of a custom game server binary is just as applicable.
Run the game server binary with the command:</p><pre tabindex=0><code>docker run --rm --network=&#34;host&#34; us-docker.pkg.dev/codeblind/examples/simple-server:0.27
</code></pre><p>The <code>--rm</code> flag will nicely autoclean up the docker container after exiting.
The <code>--network="host"</code> flag will tell the docker container to use the host&rsquo;s network stack directly; this allows calls to <code>localhost</code> to reach the SDK Server.
The commands and flags used will likely differ if running a custom game server binary.</p><p>If the earlier <code>kubectl get --watch</code> command was run, it will now show the <code>GameServer</code> progressed to the <code>RequestReady</code> state, which will automatically be progressed to the <code>Ready</code> state by the Code Blind controller on the cluster.</p><p>The <code>GameServer</code> state can further be modified by SDK calls, gRPC/REST calls, allocation via either <a href=http://localhost:1313/docs/reference/gameserverallocation/><code>GameServerAllocation</code></a> or <a href=http://localhost:1313/docs/advanced/allocator-service/>Allocator Service</a>, K8s API calls, etc.
These changes will be shown by the <code>kubectl get --watch</code> command.
These changes will also be picked up by the game server binary, if there is a listener registered through the SDK API.
This means that this <code>GameServer</code> can be allocated just as it would be when running completely on k8s, but it can be locally debugged.</p><p>If the server crashes or is killed by the developer, it can easily be restarted.
This can be done without restarting the SDK Server or any other manual intevention with the <code>GameServer</code> resource.
Naturally, this may have implications on any connected clients, but that is project specific and left to the developer to handle.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a147578c54e3cfc51d8c84b30bc32cc9>6 - Allocator Service</h1><div class=lead>Code Blind provides an mTLS based allocator service that is accessible from outside the cluster using a load balancer. The service is deployed and scales independent to Code Blind controller.</div><p>To allocate a game server, Code Blind provides a gRPC and REST service with mTLS authentication, called <code>agones-allocator</code> that can be used instead of
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>GameServerAllocations</a>.</p><p>Both gRPC and REST are accessible through a Kubernetes service that can be externalized using a load balancer. By default, gRPC and REST are served from the same port. However, either service can be disabled or the services can be served from separate ports using the <a href=/docs/installation/install-agones/helm/>helm configuration</a>.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4><p>If gRPC and REST are served using the same port, then an http multi-plexer is used along with an <a href=https://github.com/grpc/grpc-go/blob/2608e38e6386be7400720fecf2ece176c4cbc1b2/server.go#L933-L960>experimental gRPC server</a> which has <a href=https://github.com/grpc/grpc-go/issues/586#issuecomment-286257439>noticeably worse performance</a> than using the standard gRPC server.</p><p>If you require a fully compatible or feature compatible gRPC server implementation, you must separate the gRPC port from the REST port or disable the REST service.</p></div><p>For requests to either service to succeed, a client certificate must be provided that is in the authorization list of the allocator service.
The remainder of this article describes how to manually make a successful allocation request using the API.</p><p>The guide assumes you have command line tools installed for <a href=https://stedolan.github.io/jq/>jq</a>, <a href=https://golang.org/>go</a> and <a href=https://www.openssl.org/>openssl</a>.</p><h2 id=gameserverallocation-vs-allocator-service><code>GameServerAllocation</code> vs Allocator Service</h2><p>There are several reasons you may prefer to use the Allocator Service over the <code>GameServerAllocation</code> custom resource
definition, depending on your architecture and requirements:</p><ul><li>A requirement to do <a href=/docs/advanced/multi-cluster-allocation/>multi-cluster allocation</a>.</li><li>Want to create Allocations from outside the Code Blind Kubernetes cluster.</li><li>Prefer SSL based authentication over Kubernetes <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC</a>.</li><li>Prefer a <a href=https://grpc.github.io/>gRPC</a> or REST based API over an integration with the
<a href=http://localhost:1313/docs/guides/access-api/>Kubernetes API</a>.</li></ul><h2 id=find-the-external-ip>Find the external IP</h2><p>The service is hosted under the same namespace as the Code Blind controller. To find the external IP of your allocator service, replace agones-system namespace with the namespace to which Code Blind is deployed and execute the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get service agones-allocator -n agones-system
</span></span></code></pre></div><p>The output of the command should look like:</p><pre>
NAME                        TYPE           CLUSTER-IP      <b>EXTERNAL-IP</b>     PORT(S)            AGE
agones-allocator            LoadBalancer   10.55.251.73    <b>34.82.195.204</b>   443:30250/TCP      7d22h
</pre><h2 id=server-tls-certificate>Server TLS certificate</h2><p>If the <code>agones-allocator</code> service is installed as a <code>LoadBalancer</code> <a href=/docs/installation/install-agones/helm/#reserved-allocator-load-balancer-ip>using a reserved IP</a>, a valid self-signed server TLS certificate is generated using the IP provided. Otherwise, the server TLS certificate should be replaced. If you installed Code Blind using <a href=/docs/installation/install-agones/helm/>helm</a>, you can easily reconfigure the allocator service with a preset IP address by setting the <code>agones.allocator.service.loadBalancerIP</code> parameter to the address that was automatically assigned to the service and <code>helm upgrade</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>helm upgrade my-release agones/agones -n agones-system --wait <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   --set agones.allocator.service.loadBalancerIP<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>   ...
</span></span></code></pre></div><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4>The parameter used to automatically
replace the certificate changed in Code Blind 1.18.0. If you are using an older
version of Code Blind you should pass the parameter
<code>agones.allocator.http.loadBalancerIP</code> instead. If you need your script to work
with both older and newer versions of Code Blind, you can pass both parameters as
only one of them will effect the helm chart templates.</div><p>Another approach is to replace the default server TLS certificate with a certificate with CN and subjectAltName. There are multiple approaches to generate a certificate. Code Blind recommends using <a href=https://cert-manager.io/>cert-manager.io</a> solution for cluster level certificate management.</p><p>In order to use the cert-manager solution, first <a href=https://cert-manager.io/docs/installation/kubernetes/>install cert-manager</a> on the cluster.
Then, <a href=https://cert-manager.io/docs/configuration/>configure</a> an <code>Issuer</code>/<code>ClusterIssuer</code> resource and
last <a href=https://cert-manager.io/docs/usage/certificate/>configure</a> a <code>Certificate</code> resource to manage allocator-tls <code>Secret</code>.
Make sure to configure the <code>Certificate</code> based on your system&rsquo;s requirements, including the validity <code>duration</code>.</p><p>Here is an example of using a self-signed <code>ClusterIssuer</code> for configuring allocator-tls <code>Secret</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#8f5902;font-style:italic># Create a self-signed ClusterIssuer</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  selfSigned: {}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># for EKS use hostname</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># HOST_NAME=$(kubectl get services agones-allocator -n agones-system -o jsonpath=&#39;{.status.loadBalancer.ingress[0].hostname}&#39;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Create a Certificate with IP for the allocator-tls secret</span>
</span></span><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: cert-manager.io/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Certificate
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: allocator-tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: agones-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  commonName: ${EXTERNAL_IP}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ipAddresses:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - ${EXTERNAL_IP}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  secretName: allocator-tls
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  issuerRef:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    name: selfsigned
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    kind: ClusterIssuer
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Wait for the allocator-tls Secret</span>
</span></span><span style=display:flex><span>sleep <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span><span style=color:#000>TLS_CA_VALUE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get secret allocator-tls -n agones-system -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.data.ca\.crt}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Add ca.crt to the allocator-tls-ca Secret</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-tls-ca -o json -n agones-system <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data[&#34;tls-ca.crt&#34;]=&#34;&#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_VALUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;&#39;</span> <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#000>$TLS_CA_VALUE</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; ca.crt
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In case of MacOS</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># echo $TLS_CA_VALUE | base64 -D &gt; ca.crt</span>
</span></span></code></pre></div><h3 id=bring-your-own-certificates-advanced>Bring Your Own Certificates (advanced)</h3><p>If you would like to completely manage the tls secrets outside of helm, you can create them in the namespace where agones is going to be installed, and then set the helm value <code>agones.allocator.disableSecretCreation</code> to <code>true</code>. This method will also work with the cert-manager method, as long as your certificate and secret are created ahead of time, and you populate the <code>allocator-tls-ca</code> and <code>allocator-client-ca</code> yourself.</p><h2 id=client-certificate>Client Certificate</h2><p>Because agones-allocator uses an mTLS authentication mechanism, a client must provide a certificate that is accepted by the server.</p><p>If Code Blind is installed using Helm, you can leverage a default client secret, <code>allocator-client.default</code>, created in the game server namespace and allowlisted in <code>allocator-client-ca</code> Kubernetes secret. You can extract and use that secret for client side authentication, by following <a href=#send-allocation-request>the allocation example</a>.</p><p>Otherwise, here is an example of generating a client certificate using openssl.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl req -x509 -nodes -days <span style=color:#0000cf;font-weight:700>365</span> -newkey rsa:2048 -keyout client.key -out client.crt -addext <span style=color:#4e9a06>&#39;subjectAltName=IP:&#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>CERT_FILE_VALUE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>cat client.crt <span style=color:#000;font-weight:700>|</span> base64 -w 0<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In case of MacOS</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># CERT_FILE_VALUE=$(cat client.crt | base64)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allowlist client certificate</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-client-ca -o json -n agones-system <span style=color:#000;font-weight:700>|</span> jq <span style=color:#4e9a06>&#39;.data[&#34;client_trial.crt&#34;]=&#34;&#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE_VALUE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;&#39;</span> <span style=color:#000;font-weight:700>|</span> kubectl apply -f -
</span></span></code></pre></div><p>The last command creates a new entry in the secret data map for <code>allocator-client-ca</code> for the client CA. This is for the <code>agones-allocator</code> service to accept the newly generated client certificate.</p><h2 id=send-allocation-request>Send allocation request</h2><p>After setting up <code>agones-allocator</code> with server certificate and allowlisting the client certificate, the service can be used to allocate game servers. Make sure you have a <a href=http://localhost:1313/docs/getting-started/create-fleet/>fleet</a> with ready game servers in the game server namespace.</p><p>Set the environment variables and store the client secrets before allocating using gRPC or REST APIs:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>NAMESPACE</span><span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#8f5902;font-style:italic># replace with any namespace</span>
</span></span><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>KEY_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>client.key
</span></span><span style=display:flex><span><span style=color:#000>CERT_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>client.crt
</span></span><span style=display:flex><span><span style=color:#000>TLS_CA_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allocator-client.default secret is created only when using helm installation. Otherwise generate the client certificate and replace the following.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In case of MacOS replace &#34;base64 -d&#34; with &#34;base64 -D&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-client.default -n <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls\.crt}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-client.default -n <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls\.key}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-tls-ca -n agones-system -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls-ca\.crt}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><h3 id=using-grpc>Using gRPC</h3><p>To start, take a look at the allocation gRPC client examples in
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>golang</a> and
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>C#</a> languages. In the following, the
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>golang gRPC client example</a> is used to allocate a Game Server in the <code>default</code> namespace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>go run examples/allocator-client/main.go --ip <span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --port <span style=color:#0000cf;font-weight:700>443</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --namespace <span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --key <span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cert <span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cacert <span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div><h3 id=using-rest>Using REST</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>curl --key <span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --cert <span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --cacert <span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --data <span style=color:#4e9a06>&#39;{&#34;namespace&#34;:&#34;&#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     https://<span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span>/gameserverallocation <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -X POST
</span></span></code></pre></div><p>You should expect to see the following output:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;gameServerName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;game-server-name&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>&#34;ports&#34;</span><span style=color:#000;font-weight:700>:[{</span><span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;default&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>&#34;port&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>7463</span><span style=color:#000;font-weight:700>}],</span><span style=color:#204a87;font-weight:700>&#34;address&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.2.3.4&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>&#34;nodeName&#34;</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;node-name&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h3 id=sending-data-to-the-game-server>Sending Data to the Game Server</h3><p>The service accepts a <code>metadata</code> field, which can be used to apply <code>labels</code> and <code>annotations</code> to the allocated <code>GameServer</code>. The old <code>metaPatch</code> fields is now deprecated, but can still be used for compatibility. If both <code>metadata</code> and <code>metaPatch</code> fields are set, <code>metaPatch</code> is ignored.</p><h2 id=secrets-explained>Secrets Explained</h2><p><code>agones-allocator</code> has a dependency on three Kubernetes secrets:</p><ol><li><code>allocator-tls</code> - stores the server certificate.</li><li><code>allocator-client-ca</code> - stores the allocation authorized client CA for mTLS to allowlist client certificates.</li><li><code>allocator-tls-ca</code> (optional) - stores <code>allocator-tls</code> CA.</li></ol><p>The separation of CA secret from the private secret is for the security reason to avoid reading the private secret, while retrieving the allocator CA that is used by the allocation client to validate the server. It is optional to set or maintain the <code>allocator-tls-ca</code> secret.</p><h2 id=troubleshooting>Troubleshooting</h2><p>If you encounter problems, explore the following potential root causes:</p><ol><li><p>Check server certificate - Using openssl you can get the certificate chain for the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>openssl s_client -connect <span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span>:443
</span></span></code></pre></div><ul><li>Inspect the server certificate by storing the certificate returned, under <code>Server certificate</code> and validating using <code>openssl x509 -in tls.crt -text -noout</code>.</li><li>Make sure the certificate is not expired and the Subject Alternative Name is set.</li><li>If the issuer is <code>CN = allocation-ca</code>, the certificate is generated using Code Blind helm installation.</li></ul></li><li><p>Check client certificate</p><ul><li>You may get an error such as <code>rpc error: code = Unavailable desc = all SubConns are in TransientFailure, latest connection error: connection closed</code>, make sure your client certificate is allowlisted by being added to <code>allocator-client-ca</code>.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get secret allocator-client-ca -o json -n agones-system
</span></span></code></pre></div><ul><li>If the server certificate is not accepted by the client, you may get an error such as <code>rpc error: code = Unavailable desc = all SubConns are in TransientFailure, latest connection error: connection error: desc = "transport: authentication handshake failed: x509: certificate signed by unknown authority"</code>, depending on the client. In this case, verify that the TLS CA file matches the server certificate.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get secret allocator-tls -n agones-system -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls\.crt}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; tls.crt
</span></span><span style=display:flex><span>openssl verify -verbose -CAfile ca.crt tls.crt
</span></span><span style=display:flex><span>tls.crt: OK
</span></span></code></pre></div></li><li><p>Make sure the service is up and running.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pod -n agones-system <span style=color:#000;font-weight:700>|</span> grep agones-allocator
</span></span><span style=display:flex><span>agones-allocator-59b4f6b5c6-86j62      1/1     Running     <span style=color:#0000cf;font-weight:700>0</span>          6m36s
</span></span><span style=display:flex><span>agones-allocator-59b4f6b5c6-kbqrq      1/1     Running     <span style=color:#0000cf;font-weight:700>0</span>          6m45s
</span></span><span style=display:flex><span>agones-allocator-59b4f6b5c6-trbkl      1/1     Running     <span style=color:#0000cf;font-weight:700>0</span>          6m28s
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get service agones-allocator -n agones-system
</span></span><span style=display:flex><span>agones-allocator   LoadBalancer   10.55.248.14   34.82.195.204    443:32468/TCP   6d23h
</span></span></code></pre></div></li></ol><h2 id=api-reference>API Reference</h2><p>The AllocationService API is located as a gRPC service
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>here</a>. Additionally, the REST API is available as a
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>Swagger API</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-522dc6497d01e5cbc17d1c3587704eec>7 - Multi-cluster Allocation</h1><div class=lead>In order to allow allocation from multiple clusters, Code Blind provides a mechanism to set redirect rules for allocation requests to the right cluster.</div><p>There may be different types of clusters, such as on-premise, and Google Kubernetes Engine (GKE), used by a game to help with the cost-saving and availability.
For this purpose, Code Blind provides a mechanism to define priorities on the clusters. Priorities are defined on
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>GameServerAllocationPolicy</a> agones CRD. A matchmaker can enable the multi-cluster rules on a request and target <a href=/docs/advanced/allocator-service/>agones-allocator</a> endpoint in any of the clusters and get resources allocated on the cluster with the highest priority. If the cluster with the highest priority is overloaded, the allocation request is redirected to the cluster with the next highest priority.</p><p>The remainder of this article describes how to enable multi-cluster allocation.</p><h2 id=define-cluster-priority>Define Cluster Priority</h2><p><a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>GameServerAllocationPolicy</a> is the CRD defined by Code Blind for setting multi-cluster allocation rules. In addition to cluster priority, it describes the connection information for the target cluster, including the game server namespace, agones-allocator endpoint and client K8s secrets name for redirecting the allocation request. Game servers will be allocated from clusters with the lowest <code>priority</code> number. If there are no available game servers available in clusters with the lowest <code>priority</code> number, they will be allocated from clusters with the next lowest <code>priority</code> number. For clusters with the same priority, the cluster is chosen with a probability relative to its weight.</p><p>Here is an example of setting the priority for a cluster and it&rsquo;s connection rules. One such resource should be defined per cluster.</p><p>In the following example the policy is defined for cluster B in cluster A.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: multicluster.agones.dev/v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: GameServerAllocationPolicy
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: allocator-cluster-b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: cluster-a-ns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>spec:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  connectionInfo:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    allocationEndpoints:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    - 34.82.195.204
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    clusterName: &#34;clusterB&#34;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    namespace: cluster-b-ns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    secretName: allocator-client-to-cluster-b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>    serverCa: c2VydmVyQ0E=
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  priority: 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  weight: 100
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>To define the local cluster priority a GameServerAllocationPolicy should be defined <em>without</em> an <code>allocationEndpoints</code> field. If the local cluster priority is not defined, the allocation from the local cluster happens only if allocation from other clusters with the existing allocation rules is unsuccessful.</p><p>Allocation requests with multi-cluster allocation enabled but with only the local cluster available (e.g. in development) <em>must</em> have a local cluster priority defined, or the request fails with the error &ldquo;no multi-cluster allocation policy is specified&rdquo;.</p><p>The <code>namespace</code> field in <code>connectionInfo</code> is the namespace that the game servers will be allocated in, and must be a namespace in the target cluster that has been previously defined as allowed to host game servers. The <code>Namespace</code> specified in the allocation request (below) is used to refer to the namespace that the GameServerAllocationPolicy itself is located in.</p><p><code>serverCa</code> is the server TLS CA public certificate, set only if the remote server certificate is not signed by a public CA (e.g. self-signed). If this field is not specified, the certificate can also be specified in a field named <code>ca.crt</code> of the client secret (the secret referred to in the <code>secretName</code> field).</p><h2 id=establish-trust>Establish trust</h2><p>To accept allocation requests from other clusters, agones-allocator for cluster B should be configured to accept the client&rsquo;s certificate from cluster A and the cluster A&rsquo;s client should be configured to accept the server TLS certificate, if it is not signed by a public Certificate Authority (CA).</p><p>Follow the steps to configure the <a href=/docs/advanced/allocator-service/>agones allocator gRPC service</a>. The client certificate pair in the mentioned document is stored as a K8s secret. Here are the secrets to set:</p><p>1.Client certificate to talk to other clusters:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: allocator-client-to-cluster-b
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: cluster-a-ns
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tls.crt: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  tls.key: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  ca.crt: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>The certificates are base 64 string of the certificate file e.g. <code>cat ${CERT_FILE} | base64 -w 0</code></p><p>Code Blind recommends using <a href=https://cert-manager.io/>cert-manager.io</a> solution for generating client certificates.</p><p>2.Add client CA to the list of authorized client certificates by agones-allocator in the targeted cluster.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#4e9a06>&lt;&lt;EOF | kubectl apply -f -
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>apiVersion: v1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>kind: Secret
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>metadata:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  name: allocator-client-ca
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  namespace: agones-system
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>type: Opaque
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>data:
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  client1.crt: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  client2.crt: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>  clientN.crt: &lt;REDACTED&gt;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h2 id=allocate-multi-cluster>Allocate multi-cluster</h2><p>To enable multi-cluster allocation, set <code>multiClusterSetting.enabled</code> to <code>true</code> in
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>allocation.proto</a> and send allocation requests. For more information visit <a href=/docs/advanced/allocator-service/>agones-allocator</a>. In the following, using
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>allocator-client sample</a>, a multi-cluster allocation request is sent to the agones-allocator service. If the allocation succeeds, the AllocationResponse will contain a
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>Source</a> field which indicates the endpoint of the remote agones-allocator.</p><p>Set the environment variables and store the client secrets before allocating using gRPC or REST APIs</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000>NAMESPACE</span><span style=color:#ce5c00;font-weight:700>=</span>default <span style=color:#8f5902;font-style:italic># replace with any namespace</span>
</span></span><span style=display:flex><span><span style=color:#000>EXTERNAL_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>kubectl get services agones-allocator -n agones-system -o <span style=color:#000>jsonpath</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>KEY_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>client.key
</span></span><span style=display:flex><span><span style=color:#000>CERT_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>client.crt
</span></span><span style=display:flex><span><span style=color:#000>TLS_CA_FILE</span><span style=color:#ce5c00;font-weight:700>=</span>ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allocator-client.default secret is created only when using helm installation. Otherwise generate the client certificate and replace the following.</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># In case of MacOS replace &#34;base64 -d&#34; with &#34;base64 -D&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-client.default -n <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls\.crt}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-client.default -n <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span> -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls\.key}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>kubectl get secret allocator-tls-ca -n agones-system -ojsonpath<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;{.data.tls-ca\.crt}&#34;</span> <span style=color:#000;font-weight:700>|</span> base64 -d &gt; <span style=color:#4e9a06>&#34;</span><span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>go run examples/allocator-client/main.go --ip <span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --namespace <span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --key <span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cert <span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cacert <span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --multicluster <span style=color:#204a87>true</span>
</span></span></code></pre></div><p>If using REST use</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>curl --key <span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --cert <span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --cacert <span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -H <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     --data <span style=color:#4e9a06>&#39;{&#34;namespace&#34;:&#34;&#39;</span><span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>&#39;&#34;, &#34;multiClusterSetting&#34;:{&#34;enabled&#34;:true}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     https://<span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span>/gameserverallocation <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>     -X POST
</span></span><span style=display:flex><span>     
</span></span></code></pre></div><h2 id=troubleshooting>Troubleshooting</h2><p>If you encounter problems, explore the following potential root causes:</p><ol><li><p>Make sure single cluster allocation works for each cluster using <a href=/docs/advanced/allocator-service/#troubleshooting>this troubleshooting</a>.</p></li><li><p>For each cluster, make sure there is a <code>GameServerAllocationPolicy</code> resource defined in the game server cluster.</p></li><li><p>Inspect the <code>.spec.connectionInfo</code> for <code>GameServerAllocationPolicy</code> for each cluster. Use the cluster connection information in that field to verify that single cluster allocation works. Use the information to verify the connection:</p></li></ol><pre tabindex=0><code class=language-none data-lang=none>POLICY_NAME=&lt;policy-name&gt;
POLICY_NAMESPACE=&lt;policy-namespace&gt;

NAMESPACE=$(kubectl get gameserverallocationpolicy ${POLICY_NAME} -n ${POLICY_NAMESPACE} -ojsonpath={.spec.connectionInfo.namespace})
EXTERNAL_IP=$(kubectl get gameserverallocationpolicy ${POLICY_NAME} -n ${POLICY_NAMESPACE} -ojsonpath={.spec.connectionInfo.allocationEndpoints\[0\]})
CLIENT_SECRET_NAME=$(kubectl get gameserverallocationpolicy ${POLICY_NAME} -n ${POLICY_NAMESPACE} -ojsonpath={.spec.connectionInfo.secretName})

KEY_FILE=client.key
CERT_FILE=client.crt
TLS_CA_FILE=ca.crt

# In case of MacOS replace &#34;base64 -d&#34; with &#34;base64 -D&#34;
kubectl get secret &#34;${CLIENT_SECRET_NAME}&#34; -n &#34;${POLICY_NAMESPACE}&#34; -ojsonpath=&#34;{.data.tls\.crt}&#34; | base64 -d &gt; &#34;${CERT_FILE}&#34;
kubectl get secret &#34;${CLIENT_SECRET_NAME}&#34; -n &#34;${POLICY_NAMESPACE}&#34; -ojsonpath=&#34;{.data.tls\.key}&#34; | base64 -d &gt; &#34;${KEY_FILE}&#34;
kubectl get secret &#34;${CLIENT_SECRET_NAME}&#34; -n &#34;${POLICY_NAMESPACE}&#34; -ojsonpath=&#34;{.data.ca\.crt}&#34; | base64 -d &gt; &#34;${TLS_CA_FILE}&#34;
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span>go run examples/allocator-client/main.go --ip <span style=color:#4e9a06>${</span><span style=color:#000>EXTERNAL_IP</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --port <span style=color:#0000cf;font-weight:700>443</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --namespace <span style=color:#4e9a06>${</span><span style=color:#000>NAMESPACE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --key <span style=color:#4e9a06>${</span><span style=color:#000>KEY_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cert <span style=color:#4e9a06>${</span><span style=color:#000>CERT_FILE</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>    --cacert <span style=color:#4e9a06>${</span><span style=color:#000>TLS_CA_FILE</span><span style=color:#4e9a06>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cd42a2864dd477303091c6e62aeb3c51>8 - GameServer Pod Service Accounts</h1><div class=lead>RBAC permissions and service accounts for the <code>GameServer</code> Pod.</div><h2 id=default-settings>Default Settings</h2><p>By default, Code Blind sets up service accounts and sets them appropriately for the <code>Pods</code> that are created for <code>GameServers</code>.</p><p>Since Code Blind provides <code>GameServer</code> <code>Pods</code> with a sidecar container that needs access to Code Blind Custom Resource Definitions,
<code>Pods</code> are configured with a service account with extra RBAC permissions to ensure that it can read and modify the resources it needs.</p><p>Since service accounts apply to all containers in a <code>Pod</code>, Code Blind will automatically overwrite the mounted key for the
service account in the container that is running the dedicated game server in the backing <code>Pod</code>. This is done
since game server containers are exposed publicly, and generally don&rsquo;t require the extra permissions to access aspects
of the Kubernetes API.</p><h2 id=bringing-your-own-service-account>Bringing your own Service Account</h2><p>If needed, you can provide your own service account on the <code>Pod</code> specification in the <code>GameServer</code> configuration.</p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Warning</h4><p>If you bring your own Service Account, it&rsquo;s your responsibility to ensure it matches all the RBAC permissions
the <code>GameServer</code> <code>Pod</code> usually acquires from Code Blind by default, otherwise <code>GameServers</code> can fail.</p><p>The default RBAC permissions for can be found in the
<a href=https://github.com/josephbarnett/codeblind.ai/blob/release-1.38.0/ target=_blank data-proofer-ignore>installation
YAML on GitHub</a> and can be used for a reference.</p></div><p>For example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;agones.dev/v1&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>GameServer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>generateName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;simple-game-server-&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>7654</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my-special-service-account</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># a custom service account</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>simple-game-server</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>us-docker.pkg.dev/codeblind/examples/simple-server:0.27</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>If a service account is configured, the mounted key is not overwritten, as it assumed that you want to have full control
of the service account and underlying RBAC permissions.</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/XCuWVReewp aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="User mailing list" aria-label="User mailing list"><a target=_blank rel=noopener href=https://groups.google.com/forum/#!forum/codeblind-discuss aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=X aria-label=X><a target=_blank rel=noopener href=https://twitter.com/codeblind aria-label=X><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Community Meetings" aria-label="Community Meetings"><a target=_blank rel=noopener href=https://github.com/josephbarnett/ aria-label="Community Meetings"><i class="fab fa-youtube"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/josephbarnett/ aria-label=GitHub><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Resume aria-label=Resume><a target=_blank rel=noopener href=https://github.com/josephbarnett/ aria-label=Resume><i class="fab fa-linkedin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Facebook aria-label=Facebook><a target=_blank rel=noopener href=https://github.com/josephbarnett/ aria-label=Facebook><i class="fab fa-facebook"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Contact aria-label=Contact><a target=_blank rel=noopener href=https://github.com/josephbarnett/codeblind.ai aria-label=Contact><i class="fab fa-whatsapp"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2024
<span class=td-footer__authors>Copyright Code Blind LLC</span></span><span class=td-footer__all_rights_reserved>All Rights Reserved</span><span class=ms-2><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></span></div></div></div></footer></div><script src=/js/main.js></script><script src=/js/prism.js></script><script src=/js/tabpane-persist.js></script><script src=http://localhost:1313/js/asciinema-player.js></script></body></html>